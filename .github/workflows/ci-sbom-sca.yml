name: Security - SBOM & SCA

# C5: Правильные триггеры - только релевантные изменения
on:
  workflow_dispatch:  # Ручной запуск
  push:
    paths:
      - "**/*.py"                              # Python код
      - "requirements*.txt"                    # Зависимости
      - "Dockerfile"                          # Docker конфигурация
      - ".github/workflows/ci-sbom-sca.yml"  # Сам workflow

# C5: Минимальные права безопасности
permissions:
  contents: read

# C5: Предотвращение дублирующих запусков
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sbom_sca:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # C5: Разумный таймаут

    steps:
      # Базовая подготовка
      - name: Checkout repository
        uses: actions/checkout@v4

      # C3: Создаем структуру для артефактов
      - name: Prepare evidence directories
        run: |
          mkdir -p EVIDENCE/P09
          echo "Created evidence directory structure"
          ls -la EVIDENCE/

      # C1: Генерация SBOM с фиксированной версией инструмента
      - name: Generate SBOM with Syft (CycloneDX format)
        run: |
          echo "Generating Software Bill of Materials (SBOM)..."
          
          # Используем фиксированную версию для воспроизводимости
          docker run --rm \
            -v $PWD:/work \
            -w /work \
            anchore/syft:v1.14.0 \
            packages dir:. \
            -o cyclonedx-json \
            > EVIDENCE/P09/sbom.json
          
          echo "SBOM generated successfully"
          echo "SBOM size: $(du -h EVIDENCE/P09/sbom.json | cut -f1)"
          
          # Краткая валидация SBOM
          if jq -e '.components | length' EVIDENCE/P09/sbom.json > /dev/null; then
            component_count=$(jq '.components | length' EVIDENCE/P09/sbom.json)
            echo "Found $component_count components in SBOM"
          else
            echo "Invalid SBOM format"
            exit 1
          fi

      # C2: SCA сканирование на основе SBOM
      - name: Run SCA scan with Grype
        run: |
          echo "Starting Security Component Analysis (SCA)..."
          
          # Запускаем Grype с фиксированной версией
          docker run --rm \
            -v $PWD:/work \
            -w /work \
            anchore/grype:v0.74.7 \
            sbom:/work/EVIDENCE/P09/sbom.json \
            -o json \
            > EVIDENCE/P09/sca_report.json
          
          echo "SCA scan completed"
          echo "Report size: $(du -h EVIDENCE/P09/sca_report.json | cut -f1)"

      # C2: Создание читаемой сводки по уязвимостям
      - name: Generate SCA summary report
        run: |
          echo "Generating human-readable SCA summary..."
          
          # Начинаем создание сводки
          cat > EVIDENCE/P09/sca_summary.md << 'EOF'
          # SCA Security Analysis Summary
          
          **Generated:** $(date -Iseconds)  
          **Commit:** ${{ github.sha }}  
          **Workflow:** ${{ github.run_id }}
          
          ## Vulnerability Breakdown by Severity
          
          EOF
          
          # Подсчитываем уязвимости по severity с помощью jq
          if jq -e '.matches' EVIDENCE/P09/sca_report.json > /dev/null; then
            echo "### Severity Distribution" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md
            
            # Считаем каждую категорию отдельно для надежности
            critical_count=$(jq '[.matches[].vulnerability.severity] | map(select(. == "Critical")) | length' EVIDENCE/P09/sca_report.json)
            high_count=$(jq '[.matches[].vulnerability.severity] | map(select(. == "High")) | length' EVIDENCE/P09/sca_report.json)
            medium_count=$(jq '[.matches[].vulnerability.severity] | map(select(. == "Medium")) | length' EVIDENCE/P09/sca_report.json)
            low_count=$(jq '[.matches[].vulnerability.severity] | map(select(. == "Low")) | length' EVIDENCE/P09/sca_report.json)
            negligible_count=$(jq '[.matches[].vulnerability.severity] | map(select(. == "Negligible")) | length' EVIDENCE/P09/sca_report.json)
            
            echo "- **Critical**: $critical_count" >> EVIDENCE/P09/sca_summary.md
            echo "- **High**: $high_count" >> EVIDENCE/P09/sca_summary.md  
            echo "- **Medium**: $medium_count" >> EVIDENCE/P09/sca_summary.md
            echo "- **Low**: $low_count" >> EVIDENCE/P09/sca_summary.md
            echo "- **Negligible**: $negligible_count" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md
            
            # Выводим в консоль для логов CI
            echo "Critical: $critical_count"
            echo "High: $high_count"
            echo "Medium: $medium_count" 
            echo "Low: $low_count"
            echo "Negligible: $negligible_count"
            
            # Добавляем топ-5 уязвимостей по критичности
            echo "### Top Critical/High Vulnerabilities" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md
            
            jq -r '.matches[] | select(.vulnerability.severity == "Critical" or .vulnerability.severity == "High") | "- **\(.vulnerability.id)** (\(.vulnerability.severity)): \(.artifact.name) \(.artifact.version) - \(.vulnerability.description // "No description")"' EVIDENCE/P09/sca_report.json | head -5 >> EVIDENCE/P09/sca_summary.md || echo "No Critical/High vulnerabilities found" >> EVIDENCE/P09/sca_summary.md
            
          else
            echo "No vulnerabilities found or invalid report format" >> EVIDENCE/P09/sca_summary.md
            echo "No vulnerabilities detected"
          fi
          
          # Добавляем информацию о следующих шагах
          cat >> EVIDENCE/P09/sca_summary.md << 'EOF'
          
          ## Next Steps
          
          1. **Review Critical/High vulnerabilities** - prioritize for immediate action
          2. **Check for available updates** - update vulnerable dependencies where possible  
          3. **Create waivers** - for vulnerabilities that cannot be immediately fixed
          4. **Monitor** - set up alerts for new vulnerabilities in these components
          
          ## Files Generated
          
          - `EVIDENCE/P09/sbom.json` - Complete Software Bill of Materials
          - `EVIDENCE/P09/sca_report.json` - Detailed SCA scan results
          - `EVIDENCE/P09/sca_summary.md` - This human-readable summary
          
          EOF
          
          echo "SCA summary generated successfully"

      # C3: Сохранение метаданных о scan'е
      - name: Save scan metadata
        run: |
          echo "Saving scan metadata for traceability..."
          
          cat > EVIDENCE/P09/scan_metadata.json << EOF
          {
            "scan_date": "$(date -Iseconds)",
            "commit_sha": "${{ github.sha }}",
            "commit_ref": "${{ github.ref_name }}",
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "tools": {
              "sbom_generator": "anchore/syft:v1.14.0",
              "sca_scanner": "anchore/grype:v0.74.7",
              "sbom_format": "CycloneDX JSON"
            },
            "repository": "${{ github.repository }}",
            "actor": "${{ github.actor }}"
          }
          EOF

      # C3: Загрузка всех артефактов
      - name: Upload SBOM & SCA evidence artifacts  
        if: always()  # Загружаем даже при ошибках
        uses: actions/upload-artifact@v4
        with:
          name: P09_SBOM_SCA_Evidence
          path: EVIDENCE/P09/
          retention-days: 90  # Долгосрочное хранение для compliance

      # C2: Анализ результатов и вывод рекомендаций
      - name: Analyze scan results and provide recommendations
        if: always()
        run: |
          echo "Analysis Summary:"
          echo "=================="
          
          if [ -f "EVIDENCE/P09/sca_report.json" ]; then
            total_vulns=$(jq '.matches | length' EVIDENCE/P09/sca_report.json 2>/dev/null || echo "0")
            echo "Total vulnerabilities found: $total_vulns"
            
            if [ "$total_vulns" -gt 0 ]; then
              echo ""
              echo "Recommended Actions:"
              echo "1. Review the detailed report: EVIDENCE/P09/sca_summary.md"
              echo "2. Download artifacts from this workflow run"
              echo "3. Create issues for Critical/High severity vulnerabilities"
              echo "4. Update vulnerable dependencies where possible"
              echo "5. Create waivers in policy/waivers.yml for accepted risks"
              echo ""
              echo "Files to review:"
              echo "- EVIDENCE/P09/sbom.json (complete component inventory)"
              echo "- EVIDENCE/P09/sca_report.json (detailed vulnerability data)"
              echo "- EVIDENCE/P09/sca_summary.md (human-readable summary)"
            else
              echo "No vulnerabilities found - great security posture!"
            fi
          else
            echo "SCA report not found - check previous steps"
          fi
          
          echo ""
          echo "Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      # C5: Опциональная проверка на критические уязвимости (для продвинутого уровня)
      - name: Check for critical vulnerabilities (informational)
        if: always()
        continue-on-error: true  # Не блокируем CI, только информируем
        run: |
          if [ -f "EVIDENCE/P09/sca_report.json" ]; then
            critical_count=$(jq '[.matches[].vulnerability.severity] | map(select(. == "Critical")) | length' EVIDENCE/P09/sca_report.json)
            high_count=$(jq '[.matches[].vulnerability.severity] | map(select(. == "High")) | length' EVIDENCE/P09/sca_report.json)
            
            echo "Security Alert Summary:"
            echo "Critical vulnerabilities: $critical_count"
            echo "High vulnerabilities: $high_count"
            
            if [ "$critical_count" -gt 0 ] || [ "$high_count" -gt 0 ]; then
              echo ""
              echo "Action Required:"
              echo "Found $critical_count Critical + $high_count High severity vulnerabilities"
              echo "These should be reviewed and addressed according to your security policy"
              echo ""
              echo "In production environments, consider:"
              echo "- Failing the build for Critical vulnerabilities"
              echo "- Requiring approval for High vulnerabilities" 
              echo "- Implementing automatic dependency updates"
            fi
          fi