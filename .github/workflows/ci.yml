name: CI/CD Pipeline

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write   # Для пуша в GHCR

# C2. Concurrency - предотвращение дублирующих запусков
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # C1. Build и тесты с матрицей
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    env:
      ENV: ci
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_HOST: localhost
      DB_PORT: 5432
      DB_NAME: ${{ secrets.DB_NAME }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: ${{ secrets.DB_USER }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          POSTGRES_DB: ${{ secrets.DB_NAME }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-py${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-py${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Create reports directory
        run: mkdir -p reports

      - name: Lint with ruff
        run: |
          ruff check --output-format=github . > reports/ruff-report.txt || true
          ruff check .

      - name: Check formatting with black
        run: black --check .

      - name: Check imports with isort
        run: isort --check-only .

      - name: Run tests with coverage
        run: |
          pytest -v --tb=short \
            --junitxml=reports/junit.xml \
            --cov=app \
            --cov-report=html:reports/coverage-html \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term

      - name: Security scan with bandit
        run: |
          bandit -r app/ -f json -o reports/bandit-report.json || true
          bandit -r app/ -ll

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-py${{ matrix.python-version }}
          path: reports/
          retention-days: 30

  # C1 + C4. Сборка образа + сохранение как артефакт (для критериев) + пуш в GHCR (для реального деплоя)
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push to GHCR + save as artifact
        uses: docker/build-push-action@v5
        with:
          context: .
          target: runtime
          push: true
          tags: |
            ghcr.io/dedovinside/media-catalog-secure:latest
            ghcr.io/dedovinside/media-catalog-secure:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Дополнительно сохраняем как артефакт — для критериев P08
      - name: Save image as artifact
        run: |
          docker save ghcr.io/dedovinside/media-catalog-secure:latest | gzip > media-catalog-latest.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: media-catalog-latest.tar.gz
          retention-days: 14

  # C5. НАСТОЯЩИЙ деплой на домашний ПК + все артефакты
  deploy-staging:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    environment: staging

    steps:
      # C4. Скачиваем артефакт
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      # Реальный деплой по SSH на твой Windows-ПК
      - name: Deploy to home Windows PC via SSH
        env:
          SSH_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
          USER: ${{ secrets.DEPLOY_USER }}
          HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy

          ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no $USER@$HOST << 'EOF'
            echo "Подключились к Windows staging server ($HOST)"
            cd C:\media-catalog-deploy

            docker compose pull app
            docker compose up -d --force-recreate app

            echo "Ждём запуска приложения..."
            for i in {1..30}; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "Приложение запустилось!"
                break
              fi
              sleep 1
            done

            curl -f http://localhost:8000/health || exit 1
            echo "ДЕПЛОЙ ЗАВЕРШЁН УСПЕШНО!"
            echo "→ http://$HOST:8000/docs"
          EOF

      # C4. Отчёт о деплое
      - name: Generate deployment report
        run: |
          mkdir -p deployment-reports
          cat > deployment-reports/staging-deploy.json << EOF
          {
            "timestamp": "$(date -Iseconds)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "environment": "staging",
            "status": "success",
            "image": "ghcr.io/dedovinside/media-catalog-secure:latest",
            "deploy_url": "http://${{ secrets.DEPLOY_HOST }}:8000/docs",
            "deployer": "${{ github.actor }}"
          }
          EOF

      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: staging-deployment-report
          path: deployment-reports/