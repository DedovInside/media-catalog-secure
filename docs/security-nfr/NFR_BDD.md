# BDD Test Scenarios for Security NFR

## Media Catalog API - Behavior-Driven Development

### Функциональность: Производительность API под нагрузкой (NFR-01)

```gherkin
Feature: Производительность времени отклика API
  Как пользователь Media Catalog
  Я хочу чтобы API отвечал быстро даже под нагрузкой
  Чтобы приложение оставалось отзывчивым

  Scenario: Производительность GET /media под нормальной нагрузкой
    Given Media Catalog API запущен и в базе данных есть 100 медиа элементов
    When я отправляю 100 одновременных запросов к GET /media
    Then p95 время отклика должно быть ≤ 200мс
    And ни один запрос не должен превышать 1000мс timeout

  Scenario: Производительность POST /media при создании
    Given Media Catalog API запущен
    When я отправляю 50 одновременных POST запросов для создания медиа
    Then p95 время отклика должно быть ≤ 200мс
    And все запросы должны возвращать статус 201 или 409 (дубликат)
```

### Функциональность: Мониторинг частоты ошибок (NFR-02)

```gherkin
Feature: Контроль частоты ошибок системы
  Как системный администратор
  Я хочу мониторить частоту ошибок
  Чтобы поддерживать здоровье системы

  Scenario: Частота ошибок при нормальной работе
    Given система работает в нормальном режиме
    When 1000 корректных запросов обрабатываются за 10 минут
    Then частота 5xx ошибок должна быть ≤ 1% и частота 4xx ошибок должна быть ≤ 5%

  Scenario: Контроль частоты ошибок под высокой нагрузкой
    Given система находится под высокой нагрузкой (200 RPS)
    When нагрузочный тест выполняется в течение 5 минут
    Then частота 5xx ошибок должна оставаться ≤ 1%
    And никакие запросы не должны получать 5xx после повторной попытки
```

### Функциональность: Покрытие валидации входных данных (NFR-03)

```gherkin
Feature: Комплексная валидация пользовательского ввода
  Как система заботящаяся о безопасности
  Я хочу валидировать все пользовательские данные
  Чтобы вредоносные данные не могли скомпрометировать систему

  Сценарий: Валидация названия предотвращает XSS атаки
    Given у меня есть запрос на создание медиа
    When я устанавливаю название в "<script>alert('xss')</script>"
    Then API должен вернуть статус 422
    And ответ должен содержать ошибку валидации для поля title

  Сценарий: Валидация года предотвращает некорректные данные
    Given у меня есть запрос на создание медиа
    When я устанавливаю год в 3000 (будущая дата)
    Then API должен вернуть статус 422
    And ответ должен содержать "year must be between 1800 and 2030"

  Сценарий: Попытка SQL инъекции в названии
    Given у меня есть запрос на создание медиа
    When я устанавливаю название в "'; DROP TABLE media; --"
    Then API должен вернуть статус 422 или безопасно сохранить название как текст
    And никакие команды базы данных не должны быть выполнены
```

### Функциональность: Безопасность зависимостей (NFR-05) - Негативный сценарий

```gherkin
Feature: Управление уязвимостями зависимостей
  Как команда безопасности
  Я хочу быстро обнаруживать уязвимые зависимости
  Чтобы минимизировать риски безопасности

  Scenario: Обнаружение критической уязвимости
    Given объявлена новая критическая уязвимость в FastAPI
    When сканирование безопасности запускается в CI
    Then сборка должна провалиться если серьезность уязвимости Critical
    And команде безопасности должно быть отправлено уведомление

  Scenario: Превышен порог возраста уязвимости
    Given обнаружена уязвимость High серьезности
    When прошло 3 дня без устранения
    Then CI должен блокировать новые развертывания
    And должно быть инициировано эскалационное уведомление
```

### Функциональность: Изоляция данных между пользователями (NFR-06)

```gherkin
Feature: Изоляция пользовательских данных
  Как пользователь Media Catalog
  Я хочу видеть только свои медиа элементы
  Чтобы моя конфиденциальность была защищена

  Scenario: Пользователь может получить доступ только к своим медиа
    Given у пользователя A есть 5 медиа элементов и у пользователя B есть 3 медиа элемента
    When пользователь A запрашивает GET /media
    Then ответ должен содержать ровно 5 элементов
    And все элементы должны принадлежать пользователю A

  Scenario: Пользователь не может получить доступ к чужим медиа по ID
    Given у пользователя A есть медиа с ID 1 и пользователь B аутентифицирован
    When пользователь B запрашивает GET /media/1
    Then API должен вернуть статус 404 и ответ должен содержать "not found"

  Scenario: Пользователь не может удалить чужие медиа
    Given у пользователя A есть медиа с ID 1 и пользователь B аутентифицирован
    When пользователь B отправляет DELETE /media/1
    Then API должен вернуть статус 404 и медиа должно по-прежнему существовать в каталоге пользователя A
```

### Функциональность: Ограничение размера запросов (NFR-07)

```gherkin
Feature: Защита от больших запросов
  Как защитник системы
  Я хочу ограничивать размеры запросов
  Чтобы предотвратить DoS атаки через большие payload

  Scenario: Принятие запроса нормального размера
    Given у меня есть корректный запрос на создание медиа
    When размер payload запроса составляет 100KB
    Then API должен принять и обработать запрос и вернуть статус 201

  Scenario: Отклонение слишком большого запроса
    Given у меня есть запрос на создание медиа
    When размер payload запроса превышает 1MB
    Then API должен вернуть статус 413 (Payload Too Large)
    And запрос не должен быть обработан
    And не должно произойти исчерпания памяти
```

### Функциональность: Защита от превышения лимита запросов (NFR-08)

```gherkin
Feature: Защита от DDoS через ограничение частоты
  Как системный администратор
  Я хочу ограничивать частоту запросов на IP
  Чтобы система оставалась доступной во время атак

  Scenario: Принятие нормальной частоты запросов
    Given клиент с IP адресом 192.168.1.100
    When клиент отправляет 50 запросов в минуту
    Then все запросы должны быть обработаны нормально
    And статус ответа должен быть 200/201

  Scenario: Применение ограничения частоты
    Given клиент с IP адресом 192.168.1.100
    When клиент отправляет 150 запросов в минуту
    Then запросы после 100-го должны возвращать статус 429
    And ответ должен содержать "rate limit exceeded"
    And легитимные пользователи не должны быть затронуты
```

### Функциональность: Аудит логирование (NFR-09)

```gherkin
Feature: Аудит логирование CRUD операций
  Как аудитор безопасности
  Я хочу чтобы все CRUD операции логировались
  Чтобы действия пользователей можно было отследить

  Scenario: Логирование создания медиа
    Given пользователь создает новое медиа
    When POST /media вызывается успешно
    Then должна быть создана запись в аудит логе
    And лог должен содержать user_id, action, timestamp, media_id
    And уровень лога должен быть INFO

  Scenario: Логирование удаления медиа
    Given пользователь удаляет медиа с ID 123
    When DELETE /media/123 вызывается
    Then должна быть создана запись в аудит логе
    And лог должен содержать "action": "delete_media"
    And лог должен включать детали удаленного медиа
```

### Функциональность: Управление секретами (NFR-10)

```gherkin
Feature: Безопасное управление конфигурацией
  Как инженер безопасности
  Я хочу гарантировать что секреты не раскрываются
  Чтобы чувствительная информация оставалась защищенной

  Scenario: Валидация переменных окружения
    Given приложение запускается
    When конфигурация загружается
    Then в коде не должно быть найдено хардкод секретов
    And вся чувствительная конфигурация должна поступать из переменных окружения
    And логи не должны содержать никаких секретных значений

  Scenario: Обнаружение секретов в коммитах
    Given разработчик коммитит изменения кода
    When pre-commit хуки выполняются
    Then не должно быть обнаружено API ключей, паролей или токенов
    And коммит должен быть заблокирован если найдены секреты
```

### Функциональность: Безопасность тел ошибок (NFR-13)

```gherkin
Feature: Безопасные тела ошибок согласно SECURITY.md
  Как система заботящаяся о безопасности
  Я хочу не раскрывать чувствительную информацию в ошибках
  Чтобы злоумышленники не получили данные через error messages

  Scenario: Not Found ошибки не раскрывают конкретные ID
    Given медиа с ID 999 не существует
    When я запрашиваю GET /media/999
    Then error.message должен быть "Resource not found"
    And не должен содержать конкретный ID "999"
    And должен следовать единому формату из SECURITY.md

  Scenario: Дубликат ошибки не раскрывают пользовательские данные
    Given в системе есть медиа "Secret Project" пользователя A
    When я пытаюсь создать медиа с тем же названием
    Then error.message должен быть "Resource already exists"
    And не должен содержать название "Secret Project"
    And не должен содержать год или тип существующего медиа

  Scenario: Валидационные ошибки не раскрывают внутреннюю схему
    Given у меня есть запрос с некорректными данными
    When я отправляю POST /media с невалидным JSON
    Then ответ должен содержать только общую информацию об ошибке
    And не должен раскрывать названия полей схемы валидации
    And не должен содержать internal stack traces

  Scenario: Маскирование пользовательских данных в логах
    Given происходит ошибка с медиа содержащим пользовательские предпочтения
    When система логирует ошибку
    Then в логах не должно быть конкретных названий медиа
    And должны быть только correlation_id для внутренней диагностики
    And пользовательские рейтинги не должны попадать в error responses
```
